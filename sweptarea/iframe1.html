<!DOCTYPE html>
<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.8.0/d3.min.js"></script>
<script type='text/javascript'>
document.addEventListener("DOMContentLoaded", function(event) {
  function observeForVisibility(target, thresholds, func)
  {
    var callback = function(entries, observer) { 
      for (var i = 0; i < entries.length; ++i)
      {
        if (entries[i].target == target)
        {
          func(target, entries[i].intersectionRatio);
        }
      }  
    }  
    var observer = new IntersectionObserver(callback, 
       {threshold: thresholds});
    observer.POLL_INTERVAL = 200;  
    observer.observe(target);
  }

var docWidth, docHeight;
function getExtent() {
  docWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
  docHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
}
window.addEventListener('resize', function(event){ getExtent(); });
getExtent();
var margin = {top: 0, right: 0, bottom: 0, left: 0},
    width = docWidth - margin.left - margin.right,
    height = docHeight - margin.top - margin.bottom,
    size = Math.min(width,height);
    
console.log(width,height);
    
// add the graph canvas to the body of the webpage
var svg = d3.select("div#plot1").append("svg")
    .attr("width", size)
    .attr("height", size);
var axis = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
var xsc = d3.scaleLinear()
          .domain([-2, 2])  // the range of the values to plot
          .range([ 0, size ]);        // the pixel range of the x-axis

var ysc = d3.scaleLinear()
          .domain([-2, 2])
          .range([ size, 0 ]);
var closedLine = d3.line()
   .x(function(d){ return xsc(d[0]); })
   .y(function(d){ return ysc(d[1]); })
   .curve(d3.curveLinearClosed);

function attrfunc(f,attr) {
  return function(d) {
    return f(d[attr]);
  };
}

function areacolor(d) { return d.area > 0 ? 'green' : 'red'; }
function doit(data)
{
  var items = axis.selectAll("path.item")
    .data(data);
  items.enter()
      .append("path")
        .attr("class", "item")
      .merge(items)
        .attr("d", attrfunc(closedLine, "xy"))
        .attr("stroke", areacolor)
        .attr("stroke-width", 1)
        .attr("stroke-opacity", function(d) { return 1-d.age;})
        .attr("fill", areacolor)
        .attr("fill-opacity", function(d) {return 1-d.age;})
        ;
  items.exit().remove();
  var points = axis.selectAll("circle.point")
    .data(data);
  points.enter()
      .append("circle")
        .attr("class","point")
        .attr("r", 1.5)
        .attr("stroke", "none")
        .attr("fill", "black") 
      .merge(points)
        .attr("cx", function(d) { return xsc(d.point.x); })
        .attr("cy", function(d) { return ysc(d.point.y); })
        .attr("fill-opacity", function(d) { return 1-d.age;})
        ;
}

var state = {
  t: 0,
  theta: 0,
  omega: 2.0,
  A: 1.0,
  N: 40,
  history: [],
  origin: [0,0],
  alpha: 0,
  running: true,
  lasttick: 0,
  ticksize: 50
}
function setup_method(state)
{
  var args = window.location.hash.slice(1).split(";");
  args.forEach(function(kv) {
    kv = kv.split('=');
    if (kv.length != 2)
      return;
    var k = kv[0];
    var v = kv[1];
    console.log(k,v);
    switch(k)
    {
      case 'origin':
        {
          var o = v.split(',');
          state.origin = [+o[0],+o[1]];
        }
        break;
      case 'alpha':
        state.alpha = +v;
        break;      
      case 'instancename':
        state.instancename = v;
        break;  
    }
  })  
}
setup_method(state);
function find_boundary(S, P0, P1)
{
  return [[P0.calc.refpoint.x,P0.calc.refpoint.y], 
          [P0.point.x,P0.point.y],
          [P1.point.x,P1.point.y],
          [P1.calc.refpoint.x,P1.calc.refpoint.y]]; 
}
function calc_area(p0, p1, p2)
{
  var dx1 = p1.x-p0.x;
  var dy1 = p1.y-p0.y;
  var dx2 = p2.x-p0.x;
  var dy2 = p2.y-p0.y;
  return (dy1*dx2 - dx1*dy2)/2; 
}
function calculate_info(S, P0, P1)
{
  var result = {};
  result.refpoint = S.alpha <= 0 
                  ? {x: S.origin[0],
                     y: -S.alpha*(P0.point.y-S.origin[1])+S.origin[1]}
                  : {x: S.alpha*(P0.point.x-S.origin[0])+S.origin[0], 
                     y: S.origin[1]};
  if (P1)
  {
    result.area = calc_area(P0.point, P1.point, P1.calc.refpoint)
                + calc_area(P1.calc.refpoint, result.refpoint, P0.point);
  }
  return result;
}
function animationfunc(elapsed)
{
  var S = state;
  var n = Math.floor((elapsed - S.lasttick) / S.ticksize);
  if (n > 10)
  {
    S.lasttick = elapsed;  
  }  
  else
  {
    while (n-- > 0)
    {
      newpoint(S);    
    }
  }    
}  

function newpoint(S)
{  
  S.lasttick += S.ticksize;
  if (S.history.length > S.N)
    S.history.pop();
  dt = S.ticksize*1e-3;  
  S.t += dt;
  S.theta += S.omega * dt;
  var P0 = {
    point: {
      t: S.t,
      x: S.A*(Math.cos(S.theta)+0*Math.cos(6*S.theta)),
      y: S.A*(Math.sin(S.theta)+0*Math.sin(6*S.theta))
    }  
  }
  S.history.unshift(P0);  // prepend array
  var P1 = (S.history.length) < 2 ? null : S.history[1];

  P0.calc = calculate_info(S, P0, P1);
  // Create regions
  var data = [];
  for (var k = 0; k < S.history.length-1; ++k)
  {
     var P0 = S.history[k];
     var P1 = S.history[k+1];  
     data.push({age: k/S.N,
                area: P0.calc.area,
                xy: find_boundary(S, P0, P1),
                point: {x:P0.point.x, y:P0.point.y}
               });
  }

  doit(data);
}

var animationtimer = d3.timer(animationfunc);

observeForVisibility(document.getElementById('plot1'), [0,0.1],
  function(target, ratio)
  {
    var to_run = (ratio > 0);
    if (to_run == state.running)
      return;
    state.running = to_run;
    if (to_run)  
    {
      console.log('restarting animation',state.instancename);
      state.lasttick = 0;
      animationtimer.restart(animationfunc); 
    }  
    else
    {
      console.log('stopping animation',state.instancename);
      animationtimer.stop();
    }  
  }
);

}); // DOMContentLoaded event
</script>
<style type='text/css'>
svg {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
</style>
</head><body>
<div id="plot1">
</div>
</body>
</html>